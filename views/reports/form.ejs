<%- include('../partials/_navbar.ejs') %>

<div class="container mt-5">
  <h2 class="mb-4 text-center">Transaction Reports</h2>

  <div class="card p-4 mb-4">
    <form method="POST" action="/reports">
      <div class="mb-3">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" class="form-control" name="startDate" id="startDate" value="<%= startDate || '' %>" required>
      </div>
      <div class="mb-3">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" class="form-control" name="endDate" id="endDate" value="<%= endDate || '' %>" required>
      </div>

      <% if (user && (user.position === "Head of Pharmacy" || user.position === "Senior Pharmacy")) { %>
        <div class="mb-3">
          <label for="healthCenter" class="form-label">Health Center</label>
          <select class="form-select" id="healthCenter" name="healthCenter">
            <option value="">-- All --</option>
            <% allowedHealthCenters.forEach(center => { %>
              <option value="<%= center._id %>" <%= selectedHealthCenter === center._id.toString() ? 'selected' : '' %>>
                <%= center.healthCenterName %> (<%= center.region %>)
              </option>
            <% }) %>
          </select>
        </div>
      <% } %>

      <button type="submit" class="btn btn-primary w-100">Search</button>
    </form>
  </div>

  <% if (results && results.length > 0) { %>
    <div class="mb-4">
      <form method="POST" action="/reports/export">
        <input type="hidden" name="startDate" value="<%= startDate %>">
        <input type="hidden" name="endDate" value="<%= endDate %>">
        <% if (selectedHealthCenter) { %>
          <input type="hidden" name="healthCenter" value="<%= selectedHealthCenter %>">
        <% } %>
        <button type="submit" class="btn btn-success w-100">Export to Excel</button>
      </form>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Code Number</th>
            <th>Item Name</th>
            <th>Qty In</th>
            <th>Qty Out</th>
            <th>Counter Stock</th>
            <th>Store Balance</th>
            <th>Order Number</th>
            <th>Remarks</th>
            <th>Health Center</th>
            <th>Entered By</th>
          </tr>
        </thead>
        <tbody>
          <% results.forEach(tx => { %>
            <tr>
              <td>
                <%= tx.date instanceof Date ? tx.date.toISOString().slice(0, 10) : tx.date %>
              </td>
              <td><%= tx.codeNumber.codeNumber %></td>
              <td><%= tx.codeNumber.itemName %></td>
              <td><%= tx.qtyIn %></td>
              <td><%= tx.qtyOut %></td>
              <td><%= tx.counterStock %></td>
              <td><%= tx.storeBalance %></td>
              <td><%= tx.orderNumber %></td>
              <td><%= tx.remarks %></td>
              <td><%= tx.healthCenter ? tx.healthCenter.healthCenterName : '' %></td>
              <td><%= tx.enteredBy ? tx.enteredBy.username : '' %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } else if (startDate && endDate) { %>
    <div class="alert alert-warning">
      No transactions found for the selected range.
    </div>
  <% } %>
</div>
