<%- include('../partials/_navbar.ejs') %>

<div class="container mt-5">
  <h2 class="mb-4 text-center">Medication List</h2>

  <form class="d-flex mb-2" method="GET" action="/medications">
  <input 
    type="text" 
    class="form-control me-2" 
    name="search" 
    value="<%= search %>" 
    placeholder="Search...">
  <button class="btn btn-primary" type="submit">Search</button>
</form>

<% if (user.position === "Head of Pharmacy") { %>
  <form method="GET" action="/medications" class="mb-4">
    <input type="hidden" name="search" value="<%= search %>">
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0">Filter:</label>
      <select class="form-select" name="status" onchange="this.form.submit()">
        <option value="all" <%= status === 'all' ? 'selected' : '' %>>All</option>
        <option value="active" <%= status === 'active' ? 'selected' : '' %>>Active</option>
        <option value="inactive" <%= status === 'inactive' ? 'selected' : '' %>>Inactive</option>
      </select>
    </div>
  </form>
<% } %>


  <div class="mb-4">
    <% if (user.position === "Head of Pharmacy") { %>
      <a class="btn btn-success me-2" href="/medications/new">Add New Medication</a>
      <a class="btn btn-outline-primary me-2" href="/medications/import">Import Medication Catalog</a>
      <a class="btn btn-outline-secondary" href="/transactions/import">Import Transactions</a>
    <% } %>

    <% if (user.position !== "Head of Pharmacy") { %>
      <a class="btn btn-outline-secondary" href="/transactions/import">Import Transactions</a>
    <% } %>
  </div>

<% if (medications.length > 0) { %>
  <div class="list-group">
    <% medications.forEach(item => { %>
      <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <a class="text-decoration-none" href="/medications/<%= item._id %>">
            <strong><%= item.codeNumber %></strong> - <%= item.itemName %>
          </a>
        </div>
        <% if (user.position === "Head of Pharmacy") { %>
          <div class="d-flex gap-2">
            <form method="POST" action="/medications/<%= item._id %>/toggle" style="display:inline;">
              <button type="submit" class="btn btn-sm <%= item.active ? 'btn-warning' : 'btn-success' %>">
                <%= item.isActive ? 'Deactivate' : 'Activate' %>
              </button>
            </form>
            <a class="btn btn-sm btn-warning" href="/medications/<%= item._id %>/edit">Edit</a>
            <form method="POST" action="/medications/<%= item._id %>?_method=DELETE" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-danger">Delete</button>
            </form>
          </div>
        <% } %>
      </div>
    <% }) %>
  </div>
<% } else { %>
  <div class="alert alert-info">
    No medications found.
  </div>
<% } %>
</div>